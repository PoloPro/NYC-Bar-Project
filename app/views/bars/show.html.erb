<!-- mapbox -->
<script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />

<!-- mapbox-GL -->
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://api.mapbox.com/mapbox-gl-js/v0.18.0/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v0.18.0/mapbox-gl.css' rel='stylesheet' />
<!--end of scripts -->

<h1 id='bar-name'><%= @bar.name %></h1>
<strong>
  <ul class="list-inline">
    <% @bar.categories.each do |category| %>
    <li class="list-inline-item">
      <%= link_to category.name, category %><%= " | " unless category == @bar.categories.last %>
    </li>
    <% end %>
  </ul>
</strong>
<%= render partial: "rating_small", locals: { rating: @bar.rounded_average_rating } %>
<em>(<%= @bar.reviews.count %> reviews)</em>

<hr>
<div id='barmap'></div>
<div id='bar-lat' style=display:none><%= @bar.latitude %></div>
<div id='bar-lng' style=display:none><%= @bar.longitude %></div>
<div>
  <ul>
    <li><strong>Yelp ID:</strong> <%= @bar.yelp_id %></li>
    <li><strong>Address:</strong>  <%= @bar.address %></li>
    <li><strong>Zipcode:</strong>  <%= @bar.zipcode %></li>
    <li>
      <strong>Yelp Rating:</strong>  <%= @bar.yelp_rating %> stars
    </li>
  </ul>
</div>
<hr>
<div id="reviews">
  <h3>Reviews</h3>
  <div id = all_reviews>
    <div id="new_review" class=review></div>
    <% if @reviews %>
    <%= render partial: "reviews", locals: { reviews: @reviews } %>
    <% end %>
  </div>
  <div id = "new_review_form_area">
    <div id = "new_review_form">
      <% if !@already_reviewed %>
      <h3>Write a Review</h3>
      <%= form_for @review do |f| %>
      <%= f.hidden_field :bar_id, value: @bar.id %>
      <%= f.hidden_field :user_id, value: current_user.id %>
      <%= f.label :rating, "Rating" %><br>
      <%= f.text_field :rating %><br>
      <%= f.label :content, "Review" %><br>
      <%= f.text_area :content%><br>
      <%= f.submit %>
      <% end %>
      <% end %>
    </div>
  </div>
</div>
<br>
<br>
<hr>

<script>
//More maps!
var initShowPageMap = function(lat, lng){

  //access token
  mapboxgl.accessToken = 'pk.eyJ1IjoicmhvcHJoaCIsImEiOiJjaW9mN3J3OGYwMHN5eThtMnJ3enF0aHU4In0.cNczHe5-6C2mHIR5ivaKOw'
  //instantiate map
  var barmap = new mapboxgl.Map({
    container: 'barmap',
    minZoom: 9,
    maxZoom: 19,
    bearing: 29,
    center: [lng, lat],
    zoom: 17,
    style: 'mapbox://styles/rhoprhh/cioegtr6d0011ainlkhuy28e8'
  });
  //create marker for the bar
  var createMarker = function(){
    var geo = {"type": "geojson","data": {"type": "FeatureCollection","features": [{"type": "Feature","geometry": {"type": "Point","coordinates": [$('#bar-lng').html(), $('#bar-lat').html()]},"properties": {"title": $('#bar-name').html() }}]}}
    barmap.addSource('barmarker', geo)
  }
  // add it to the map
  var addMarker = function(){
    barmap.addLayer({
      "id": "barmarker",
      "type": "symbol",
      "source": "barmarker",
      "layout": {
        "icon-image": "bar-15",
        "text-field": "{title}",
        "text-font": ["Elementa Pro Bold"],
        "text-offset": [0, 0.6],
        "text-anchor": "top"
      }
    })
  }
  // call the 2 above functions once the map loads
  barmap.on('load', function(){
    createMarker();
    addMarker();
  })

}

$(document).ready(function(){
  var lat = $('#bar-lat').html();
  var lng = $('#bar-lng').html();
  initShowPageMap(lat,lng);
})

</script>
